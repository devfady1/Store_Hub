{% extends 'pages/base.html' %}
{% block content %}
<!DOCTYPE html>
<html lang="en">
{% load static %}
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="{% static 'css/style_delivery.css' %}" />

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://unpkg.com/boxicons@2.1.2/css/boxicons.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
    <title>Store Hub | Delivery Order Details</title>
    
</head>

<body class="light">
    <div class="container-delivery-order">
        <div class="left-panel">
            <div class="customer-info">
                <h3>Customer Information</h3>
                <p><i class="fas fa-user icon"></i> {{ order.customer.get_full_name|default:order.customer.username }}</p>
                <p><i class="fas fa-id-card icon"></i> Order #{{ order.id }}</p>
                <p><i class="fas fa-phone icon"></i> {{ order.customer.userprofile.phone_number|default:"Not provided" }}</p>
            </div>

            <div class="order-details">
                <h3><i class="fas fa-clipboard-list icon"></i> Order Details</h3>
                {% for item in items %}
                <div>
                    <span>{{ item.quantity }}x {{ item.product.name }}</span>
                    <span>${{ item.product.price|floatformat:2 }}</span>
                </div>
                {% endfor %}
                <div class="total">
                    <span>Total</span>
                    <span>${{ total_price|floatformat:2 }}</span>
                </div>
            </div>

            <div class="delivery-status">
                <h3>Delivery Status</h3>
                <div class="status-item">
                    <div class="status-item-span">
                        <span><i class="fa-solid fa-circle-check" style="color: var(--main-color);"></i> Order Received</span>
                        <span>{{ order.order_date|time:"H:i" }}</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-item-span">
                        <span><i class="fa-solid {% if order.status == 'preparing' or order.status == 'on_way' or order.status == 'delivered' %}fa-circle-check{% else %}fa-circle{% endif %}" style="color: {% if order.status == 'preparing' or order.status == 'on_way' or order.status == 'delivered' %}var(--main-color){% else %}#ccc{% endif %};"></i> Preparing Order</span>
                        <span>{{ order.preparing_time|default:"-" }}</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-item-span">
                        <span><i class="fa-solid {% if order.status == 'on_way' or order.status == 'delivered' %}fa-circle-check{% else %}fa-circle{% endif %}" style="color: {% if order.status == 'on_way' or order.status == 'delivered' %}var(--main-color){% else %}#ccc{% endif %};"></i> On the Way</span>
                        <span>{{ order.pickup_time|default:"-" }}</span>
                    </div>
                </div>
                <div class="status-item">
                    <div class="status-item-span">
                        <span><i class="fa-solid {% if order.status == 'delivered' %}fa-circle-check{% else %}fa-circle{% endif %}" style="color: {% if order.status == 'delivered' %}var(--main-color){% else %}#ccc{% endif %};"></i> Delivered</span>
                        <span>{{ order.delivery_time|default:"-" }}</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="right-panel">
            <div class="right-panel-1">
                <div id="map" style="height: 500px; width: 100%; border-radius: 12px;"></div>
                <div class="location-info">
                    <div class="location-info-icon">
                        <i class="fas fa-map-marker-alt map-pin-pickup"></i>
                        <div>
                            <h4>Pickup Location</h4>
                            <p>{{ order.pickup_address|default:"Store Location" }}</p>
                        </div>
                    </div>
                    <div class="location-info-icon">
                        <i class="fas fa-map-marker-alt map-pin-delivery"></i>
                        <div>
                            <h4>Delivery Location</h4>
                            <p>{{ order.delivery_address|default:"Customer Location" }}</p>
                        </div>
                    </div>
                </div>
            </div>
            <div class="right-panel-2">
                <div class="delivery-info">
                    <div class="delivery-info-top">
                        <div class="icon-info">
                            <i class="fas fa-clock icon"></i>
                            <div>
                                <h4>Estimated Delivery Time</h4>
                                <p id="eta">Calculating...</p>
                            </div>
                        </div>
                        <div class="icon-info">
                            <i class="fas fa-road icon"></i>
                            <div>
                                <h4>Distance</h4>
                                <p id="distance">Calculating...</p>
                            </div>
                        </div>
                    </div>
                    <div class="delivery-info-bottom">
                        {% if order.status == 'accepted' %}
                        <button class="start-delivery" onclick="updateStatus('on_way')">
                            <i class="fa-solid fa-truck"></i> Start Delivery
                        </button>
                        {% elif order.status == 'on_way' %}
                        <button class="complete-delivery" onclick="updateStatus('delivered')">
                            <i class="fa-solid fa-circle-check"></i> Complete Delivery
                        </button>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="{% static 'js/test.js' %}"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script>
        let map;
        let routeLayer;
        const driverMarker = L.marker([{{ driver_lat }}, {{ driver_lng }}]);
        const sellerMarker = L.marker([{{ seller_lat }}, {{ seller_lng }}]);
        const clientMarker = L.marker([{{ client_lat }}, {{ client_lng }}]);

        function initMap() {
            map = L.map('map').setView([{{ driver_lat }}, {{ driver_lng }}], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            driverMarker.addTo(map).bindPopup('ðŸšš Driver');
            sellerMarker.addTo(map).bindPopup('ðŸª Seller');
            clientMarker.addTo(map).bindPopup('ðŸ“ Customer');

            updateRoute();
        }

        function updateRoute() {
            const coordinates = [
                [{{ driver_lng }}, {{ driver_lat }}],
                [{{ seller_lng }}, {{ seller_lat }}],
                [{{ client_lng }}, {{ client_lat }}]
            ];

            fetch('https://api.openrouteservice.org/v2/directions/driving-car/geojson', {
                method: 'POST',
                headers: {
                    'Authorization': '5b3ce3597851110001cf624849ee31d7612e44018effded422136ba4',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ coordinates: coordinates })
            })
            .then(response => response.json())
            .then(data => {
                if (routeLayer) {
                    map.removeLayer(routeLayer);
                }
                routeLayer = L.geoJSON(data, {
                    style: { color: '#0066ff', weight: 5 }
                }).addTo(map);

                // Update ETA and distance
                const distance = (data.features[0].properties.segments[0].distance / 1000).toFixed(1);
                const duration = Math.round(data.features[0].properties.segments[0].duration / 60);
                document.getElementById('distance').textContent = distance + ' km';
                document.getElementById('eta').textContent = duration + ' minutes';

                map.fitBounds(routeLayer.getBounds());
            })
            .catch(error => console.error('Error:', error));
        }

        function updateStatus(newStatus) {
            fetch(`/update-order-status/{{ order.id }}/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': '{{ csrf_token }}'
                },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    location.reload();
                }
            })
            .catch(error => console.error('Error:', error));
        }

        // Initialize map
        initMap();

        // Update driver location periodically
        if ("geolocation" in navigator) {
            function updateLocation(position) {
                const { latitude, longitude } = position.coords;
                driverMarker.setLatLng([latitude, longitude]);
                
                fetch(`/live-location-update/{{ order.id }}/`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: JSON.stringify({
                        lat: latitude,
                        lng: longitude
                    })
                })
                .then(() => updateRoute())
                .catch(error => console.error('Error:', error));
            }

            const watchId = navigator.geolocation.watchPosition(updateLocation, 
                error => console.error('Error:', error),
                { enableHighAccuracy: true }
            );
        }
    </script>

</body>

</html>
{% endblock %}
